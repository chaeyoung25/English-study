<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¸ì¥ ì•”ê¸° ë„ìš°ë¯¸ (ë™ê¸°í™”)</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#007bff">

    <style>
        /* --- 1. ê¸°ë³¸ ë° ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ --- */
        :root {
            --bg-color: #f4f4f9; --text-color: #333; --card-bg: #ffffff;
            --border-color: #ddd; --primary-color: #007bff; --primary-text: #ffffff;
            --danger-color: #dc3545; --secondary-color: #6c757d; --success-color: #28a745;
        }
        body.dark-mode {
            --bg-color: #2c2c2c; --text-color: #f1f1f1; --card-bg: #444;
            --border-color: #555; --primary-color: #58a6ff; --primary-text: #2c2c2c;
            --danger-color: #ff7b72; --secondary-color: #aaa; --success-color: #7ee787;
        }

        /* --- 2. ê¸°ë³¸ ë ˆì´ì•„ì›ƒ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; box-sizing: border-box;
        }
        .container { width: 100%; max-width: 95vw; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: 2em; margin: 0; }
        .card {
            background-color: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);
            padding: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* --- 3. Google Drive ë™ê¸°í™” --- */
        .sync-card { display: flex; gap: 10px; align-items: center; }
        .sync-card input { flex-grow: 1; }
        .sync-card button { white-space: nowrap; }

        /* --- 4. ì•”ì†¡ ì˜ì—­ --- */
        .memorizer {
            text-align: center; min-height: 350px; display: flex; flex-direction: column;
            justify-content: center; margin-bottom: 20px;
        }
        #item-topic {
            font-size: 1.8em; font-weight: 600; margin-bottom: 20px; color: var(--secondary-color);
        }
        #item-english {
            font-size: 2.2em; line-height: 1.6; margin-bottom: 10px;
        }
        #item-korean {
            font-size: 1.3em; color: var(--primary-color); line-height: 1.5;
        }
        .navigation { display: flex; justify-content: space-between; margin-top: 25px; }

        /* --- 5. ë¡œì»¬ ì¶”ê°€ í¼ --- */
        .add-form, .bulk-add-form {
            display: none; flex-direction: column; gap: 15px; margin-top: 20px;
        }
        .add-form.active, .bulk-add-form.active { display: flex; }
        .form-group { display: flex; flex-direction: column; gap: 10px; }
        .form-group input, .form-group textarea { width: 100%; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .bulk-add-form textarea { min-height: 200px; resize: vertical; }
        .bulk-add-form .instructions {
            font-size: 0.9em; color: var(--secondary-color); margin: -5px 0 0 0;
            padding: 10px; background-color: var(--bg-color); border-radius: 5px;
        }
        .bulk-options { display: flex; justify-content: space-between; align-items: center; }

        /* --- 6. ì…ë ¥ í•„ë“œ ë° ë²„íŠ¼ (ê³µí†µ) --- */
        input[type="text"], input[type="number"], input[type="url"], textarea {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 5px; background-color: var(--bg-color); color: var(--text-color); box-sizing: border-box;
        }
        button {
            padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;
            font-weight: 600; transition: background-color 0.2s, opacity 0.2s;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); }
        .btn:hover { background-color: var(--border-color); }
        .btn-primary { background-color: var(--primary-color); color: var(--primary-text); border: 1px solid var(--primary-color); }
        .btn-primary:hover { opacity: 0.8; }
        .btn-danger { background-color: var(--danger-color); color: #fff; border: 1px solid var(--danger-color); }
        .btn-danger:hover { opacity: 0.8; }
        .btn-success { background-color: var(--success-color); color: #fff; border: 1px solid var(--success-color); }
        .add-controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .add-controls button { flex: 1; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>ë¬¸ì¥ ì•”ê¸° ë„ìš°ë¯¸</h1>
            <button id="btn-dark-mode" class="btn">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
        </div>

        <div class="card memorizer">
            <div id="item-topic">Apps Script URLì„ ì…ë ¥í•˜ê³  ë™ê¸°í™” í•´ì£¼ì„¸ìš”.</div>
            <div id="item-english"></div>
            <div id="item-korean"></div>
            <div class="navigation">
                <button id="btn-prev" class="btn">ì´ì „</button>
                <button id="btn-next" class="btn">ë‹¤ìŒ</button>
            </div>
        </div>

        <p style="font-size: 0.9em; text-align: center; color: var(--secondary-color);">
            (ì°¸ê³ : ì—¬ê¸°ì„œ ì‚­ì œí•´ë„ Google Drive ì›ë³¸ íŒŒì¼ì€ ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ìŒ 'ë¶ˆëŸ¬ì˜¤ê¸°' ì‹œ ë‹¤ì‹œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.)
        </p>
        <button id="btn-delete" class="btn-danger" style="width: 100%;">í˜„ì¬ ë¬¸ì¥ ì„ì‹œ ì‚­ì œ</button>

        <div class="card sync-card" style="margin-top: 20px;">
            <input type="url" id="gdrive-url-input" placeholder="Google Apps Script ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”">
            <button id="btn-gdrive-sync" class="btn-success">ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>


        <hr style="margin: 20px 0; border-color: var(--border-color);">
        <h3 style="text-align: center;">ë¡œì»¬ì—ë§Œ ì„ì‹œë¡œ ë¬¸ì¥ ì¶”ê°€í•˜ê¸°</h3>
        <div class="add-controls">
            <button id="btn-toggle-add" class="btn-primary">â• ìƒˆ ë¬¸ì¥ ì¶”ê°€</button>
            <button id="btn-toggle-bulk-add" class="btn-primary">ğŸ—‚ï¸ í•œ ë²ˆì— ì—¬ëŸ¬ ë¬¸ì¥ ì¶”ê°€</button>
        </div>

        <div class="card add-form" id="add-form">
            <h3>ìƒˆ ë¬¸ì¥ ì¶”ê°€ (ë¡œì»¬)</h3>
           <div class="form-group">
               <input type="text" id="input-topic" placeholder="ì£¼ì œ (ì˜ˆ: ì˜í™”, íŒ¨í„´)" required>
               <textarea id="input-english" placeholder="ì•”ê¸°í•  ì˜ì–´ ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”..." required style="min-height: 80px;"></textarea>
               <input type="text" id="input-korean" placeholder="í•œê¸€ ëœ» (ì„ íƒ ì‚¬í•­)">
           </div>
           <div class="form-actions">
               <button id="btn-cancel-add" class="btn">ì·¨ì†Œ</button>
               <button id="btn-save" class="btn-primary">ì €ì¥í•˜ê¸°</button>
           </div>
       </div>

       <div class="card bulk-add-form" id="bulk-add-form">
           <h3>í•œ ë²ˆì— ì—¬ëŸ¬ ë¬¸ì¥ ì¶”ê°€ (ë¡œì»¬)</h3>
           <p class="instructions">
               í˜•ì‹ 1: <b>[ì£¼ì œ] [ì˜ì–´ ë¬¸ì¥] | [í•œê¸€ ëœ»]</b><br>
               í˜•ì‹ 2: <b>[ì£¼ì œ] [ì˜ì–´ ë¬¸ì¥]</b> (í•œê¸€ ëœ» ìƒëµ)<br>
               ì˜ˆ: ì˜í™”(Movie) I'll be back. | ë‚˜ëŠ” ëŒì•„ì˜¬ ê²ƒì´ë‹¤.
           </p>
           <textarea id="bulk-input-text" placeholder="ì´ê³³ì— ë¬¸ì¥ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
           <div class="bulk-options">
               <div>
                   <input type="checkbox" id="check-overwrite">
                   <label for="check-overwrite">ê¸°ì¡´ ë¡œì»¬ ë¬¸ì¥ ë®ì–´ì“°ê¸°</label>
               </div>
               <div class="form-actions" style="margin: 0;">
                   <button id="btn-bulk-cancel" class="btn">ì·¨ì†Œ</button>
                   <button id="btn-bulk-save" class="btn-primary">ì €ì¥í•˜ê¸°</button>
               </div>
           </div>
       </div>
    </div>

    <script>
        // --- ì•± ë¡œì§ ìŠ¤í¬ë¦½íŠ¸ ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
            const itemTopicEl = document.getElementById('item-topic');
            const itemEnglishEl = document.getElementById('item-english');
            const itemKoreanEl = document.getElementById('item-korean');
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const btnDelete = document.getElementById('btn-delete');
            const btnDarkMode = document.getElementById('btn-dark-mode');
            const gdriveUrlInput = document.getElementById('gdrive-url-input');
            const btnGdriveSync = document.getElementById('btn-gdrive-sync');
            const btnToggleAdd = document.getElementById('btn-toggle-add');
            const btnToggleBulkAdd = document.getElementById('btn-toggle-bulk-add');
            const addControls = document.querySelector('.add-controls');
            const addForm = document.getElementById('add-form');
            const btnCancelAdd = document.getElementById('btn-cancel-add');
            const btnSave = document.getElementById('btn-save');
            const inputTopic = document.getElementById('input-topic');
            const inputEnglish = document.getElementById('input-english');
            const inputKorean = document.getElementById('input-korean');
            const bulkAddForm = document.getElementById('bulk-add-form');
            const bulkInputText = document.getElementById('bulk-input-text');
            const btnBulkSave = document.getElementById('btn-bulk-save');
            const btnBulkCancel = document.getElementById('btn-bulk-cancel');
            const checkOverwrite = document.getElementById('check-overwrite');

            // --- 2. ìƒíƒœ ë³€ìˆ˜ ---
            let items = [];
            let currentItemIndex = 0;

            // --- 3. Google Apps Script í•¨ìˆ˜ ---
            async function fetchItemsFromAppScript() {
                const appScriptUrl = gdriveUrlInput.value.trim();
                if (!appScriptUrl) { alert('Google Apps Script ì›¹ ì•± URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                if (!appScriptUrl.startsWith("https://script.google.com/")) { alert("ì˜¬ë°”ë¥¸ Google Apps Script ì›¹ ì•± URLì´ ì•„ë‹Œ ê²ƒ ê°™ìŠµë‹ˆë‹¤."); return; }

                btnGdriveSync.disabled = true; btnGdriveSync.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                try {
                    const response = await fetch(appScriptUrl);
                    if (!response.ok) throw new Error(`HTTP ìƒíƒœ: ${response.status}`);
                    const textData = await response.text();
                    if (textData.startsWith("ì˜¤ë¥˜:")) throw new Error(textData);

                    const regex = /^(\S+)\s+(.+?)(?:\s*\|\s*(.+))?$/gm;
                    const newItems = [];
                    const lines = textData.split('\n');
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        regex.lastIndex = 0;
                        const match = regex.exec(line.trim());
                        if (match) {
                            newItems.push({
                                topic: match[1].trim(),
                                english: match[2].trim(),
                                korean: match[3] ? match[3].trim() : ""
                            });
                        }
                    }
                    items = newItems; currentItemIndex = 0;
                    saveItemsToLocal();
                    localStorage.setItem('gdriveAppScriptUrl', appScriptUrl);
                    alert(`${items.length}ê°œì˜ ë¬¸ì¥ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                    renderCurrentItem();
                } catch (error) {
                    console.error('Apps Script ë™ê¸°í™” ì˜¤ë¥˜:', error);
                    alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
                } finally {
                    btnGdriveSync.disabled = false; btnGdriveSync.textContent = 'ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸°';
                }
            }

            // --- 4. ë¡œì»¬ ì €ì¥ì†Œ ë° ë Œë”ë§ í•¨ìˆ˜ ---
            function loadItemsFromLocal() {
                const storedItems = localStorage.getItem('sentences');
                if (storedItems) items = JSON.parse(storedItems);
                const storedIndex = localStorage.getItem('currentItemIndex');
                currentItemIndex = storedIndex ? parseInt(storedIndex, 10) : 0;
                if (items.length === 0 || currentItemIndex >= items.length) currentItemIndex = 0;
            }
            function saveItemsToLocal() {
                localStorage.setItem('sentences', JSON.stringify(items));
                localStorage.setItem('currentItemIndex', currentItemIndex);
            }
            function isItemDuplicate(english) {
                return items.some(item => item.english.trim() === english.trim());
            }
            function renderCurrentItem() {
                if (items.length === 0) {
                    itemTopicEl.textContent = 'Apps Script URLì„ ì…ë ¥í•˜ê³  ë™ê¸°í™” í•´ì£¼ì„¸ìš”.';
                    itemEnglishEl.textContent = 'ë˜ëŠ” ì•„ë˜ì˜ ë¡œì»¬ ì¶”ê°€ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.';
                    itemKoreanEl.textContent = '';
                    btnPrev.disabled = true; btnNext.disabled = true; btnDelete.disabled = true;
                    return;
                }
                btnPrev.disabled = false; btnNext.disabled = false; btnDelete.disabled = false;
                const item = items[currentItemIndex];
                itemTopicEl.textContent = `(${item.topic})`;
                itemEnglishEl.textContent = item.english;
                itemKoreanEl.textContent = item.korean || "";
            }
            function showForm(formToShow) {
                addForm.classList.remove('active'); bulkAddForm.classList.remove('active');
                if (formToShow) {
                    formToShow.classList.add('active'); addControls.style.display = 'none';
                } else {
                    addControls.style.display = 'flex';
                }
            }
            function clearAddForm() { inputTopic.value = ''; inputEnglish.value = ''; inputKorean.value = ''; }
            function clearBulkAddForm() { bulkInputText.value = ''; checkOverwrite.checked = false; }

            // --- 5. ë‹¤í¬ ëª¨ë“œ ê´€ë¦¬ ---
            function setDarkMode(isDark) {
                if (isDark) {
                    document.body.classList.add('dark-mode'); btnDarkMode.textContent = 'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ';
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    document.body.classList.remove('dark-mode'); btnDarkMode.textContent = 'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ';
                    localStorage.setItem('darkMode', 'disabled');
                }
            }

            // --- 6. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
            btnGdriveSync.addEventListener('click', fetchItemsFromAppScript);
            btnNext.addEventListener('click', () => {
                if (items.length > 0) { currentItemIndex = (currentItemIndex + 1) % items.length; saveItemsToLocal(); renderCurrentItem(); }
            });
            btnPrev.addEventListener('click', () => {
                if (items.length > 0) { currentItemIndex = (currentItemIndex - 1 + items.length) % items.length; saveItemsToLocal(); renderCurrentItem(); }
            });
            btnDelete.addEventListener('click', () => {
                if (items.length === 0) return;
                const item = items[currentItemIndex];
                if (confirm(`[${item.english}]\nì´ ë¬¸ì¥ì„ ì„ì‹œë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    items.splice(currentItemIndex, 1);
                    if (currentItemIndex >= items.length) currentItemIndex = 0;
                    saveItemsToLocal(); renderCurrentItem();
                }
            });
            btnDarkMode.addEventListener('click', () => { setDarkMode(!document.body.classList.contains('dark-mode')); });
            btnToggleAdd.addEventListener('click', () => showForm(addForm));
            btnCancelAdd.addEventListener('click', () => { clearAddForm(); showForm(null); });
            btnSave.addEventListener('click', () => {
                const topic = inputTopic.value.trim(); const english = inputEnglish.value.trim(); const korean = inputKorean.value.trim();
                if (!topic || !english) { alert('ì£¼ì œì™€ ì˜ì–´ ë¬¸ì¥ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
                if (isItemDuplicate(english)) { alert(`[${english}]\nì´ë¯¸ ë“±ë¡ëœ ë¬¸ì¥ì…ë‹ˆë‹¤.`); return; }
                items.push({ topic, english, korean }); currentItemIndex = items.length - 1;
                saveItemsToLocal(); renderCurrentItem(); clearAddForm(); showForm(null);
            });
            btnToggleBulkAdd.addEventListener('click', () => showForm(bulkAddForm));
            btnBulkCancel.addEventListener('click', () => { clearBulkAddForm(); showForm(null); });
            btnBulkSave.addEventListener('click', () => {
                const rawText = bulkInputText.value.trim(); if (!rawText) { alert('ì¶”ê°€í•  ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                const regex = /^(\S+)\s+(.+?)(?:\s*\|\s*(.+))?$/gm;
                const newItems = []; let parseErrors = 0; const lines = rawText.split('\n');
                for (const line of lines) {
                    if (line.trim() === '') continue;
                    regex.lastIndex = 0; match = regex.exec(line.trim());
                    if (match) newItems.push({ topic: match[1].trim(), english: match[2].trim(), korean: match[3] ? match[3].trim() : "" });
                    else { console.warn('í˜•ì‹ ì˜¤ë¥˜:', line); parseErrors++; }
                }
                if (newItems.length === 0 && parseErrors > 0) { alert('í˜•ì‹ì— ë§ëŠ” ë¬¸ì¥ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }
                let addedCount = 0; let skippedCount = 0;
                if (checkOverwrite.checked) {
                    const uniqueItems = []; const seen = new Set();
                    for (const item of newItems) {
                        const key = item.english.trim();
                        if (!seen.has(key)) { uniqueItems.push(item); seen.add(key); addedCount++; } else skippedCount++;
                    }
                    items = uniqueItems; currentItemIndex = 0;
                } else {
                    const itemsToAdd = [];
                    for (const item of newItems) {
                        if (isItemDuplicate(item.english) || itemsToAdd.some(b => b.english === item.english)) skippedCount++;
                        else { itemsToAdd.push(item); addedCount++; }
                    }
                    items = items.concat(itemsToAdd);
                }
                saveItemsToLocal(); renderCurrentItem();
                let msg = `ì´ ${addedCount}ê°œì˜ ë¬¸ì¥ì„ (ë¡œì»¬ì—) ì €ì¥í–ˆìŠµë‹ˆë‹¤.`;
                if (skippedCount > 0) msg += `\n(${skippedCount}ê°œ ì¤‘ë³µ ê±´ë„ˆëœ€)`;
                if (parseErrors > 0) msg += `\n(${parseErrors}ê°œ í˜•ì‹ ì˜¤ë¥˜ ê±´ë„ˆëœ€)`;
                alert(msg); clearBulkAddForm(); showForm(null);
            });

            // --- 7. ì•± ì´ˆê¸°í™” ---
            function initialize() {
                setDarkMode(localStorage.getItem('darkMode') === 'enabled');
                const savedUrl = localStorage.getItem('gdriveAppScriptUrl');
                if (savedUrl) { gdriveUrlInput.value = savedUrl; fetchItemsFromAppScript(); }
                else { loadItemsFromLocal(); renderCurrentItem(); }
            }
            initialize();
        });
        // --- ì•± ë¡œì§ ë ---
    </script>

    <script>
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(registration => {
              console.log('SW registered: ', registration);
            }).catch(registrationError => {
              console.log('SW registration failed: ', registrationError);
            });
          });
        }
    </script>

</body>
</html>